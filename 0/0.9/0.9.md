# 0.9. Trabajo Individual - Patrones Cloud (Informes y Videos)

# Manuel Malpartida - Retry

# El Patr√≥n Retry: Resiliencia en Sistemas de E-Commerce

## Introducci√≥n
El patr√≥n Retry es un mecanismo de tolerancia a fallos dise√±ado para manejar errores transitorios en sistemas distribuidos. En el contexto de e-commerce, donde la disponibilidad y experiencia del usuario son cr√≠ticas, este patr√≥n permite recuperarse autom√°ticamente de fallas temporales en servicios externos como pasarelas de pago, APIs de inventario o sistemas de recomendaci√≥n.

## ¬øQu√© es el Patr√≥n Retry?
El patr√≥n Retry act√∫a como un sistema de recuperaci√≥n autom√°tica que:

- Detecta fallas temporales (timeouts, errores HTTP 5xx)
- Reintenta la operaci√≥n fallida siguiendo una pol√≠tica configurable
- Implementa tiempos de espera entre reintentos (backoff)
- Finaliza cuando tiene √©xito o alcanza el l√≠mite de intentos

**Ejemplo en e-commerce**:

 - Cliente ‚Üí [Intento de pago ‚Üí Falla temporal ‚Üí Espera 1s ‚Üí Reintento ‚Üí √âxito]



## Problema que Resuelve en E-Commerce
**Desaf√≠os comunes**:
- Pagos fallidos: 15-20% de transacciones fallan inicialmente por inestabilidad en APIs de pago
- Disponibilidad de inventario: Contenciones en bases de datos durante ofertas flash
- Recomendaciones: Latencia variable en servicios de ML
- Notificaciones: Fallos en env√≠o de emails/notificaciones push

**Consecuencias sin Retry**:
- P√©rdida de ventas por fallas evitables
- Mala experiencia de usuario (errores visibles)
- Inconsistencias en datos cr√≠ticos

## Arquitectura del Patr√≥n
**Componentes clave**:
1. **Detector de fallas transitorias**: Clasifica errores como recuperables
2. **Pol√≠tica de reintentos**: Define m√°ximo de intentos y tiempos de espera
3. **Estrategia de backoff**: Calcula intervalos entre reintentos (ej: exponencial)
4. **Mecanismo de fallback**: Acci√≥n alternativa cuando se agotan los reintentos

**Flujo t√≠pico**:
1. Operaci√≥n falla por error transitorio
2. Sistema espera un intervalo calculado
3. Reintenta la operaci√≥n
4. Repite hasta √©xito o l√≠mite de intentos

## Implementaci√≥n en E-Commerce
**Tecnolog√≠as recomendadas**:
- Node.js: `async-retry`, `promise-retry`
- Java: Spring Retry, Resilience4j
- .NET: Polly
- Python: Tenacity

### Ejemplo pr√°ctico (Servicio de Pagos)
```javascript
const retry = require('async-retry');

// Simulador de servicio de pagos con fallas controladas
let attemptCount = 0;
const mockPaymentGateway = {
  charge: async (paymentData) => {
    attemptCount++;
    console.log(`üîµ Intento #${attemptCount} - Procesando pago $${paymentData.amount}`);
    
    // Simulamos fallas temporales en los primeros 2 intentos
    if (attemptCount < 3) {
      throw new Error('Error temporal: Servicio de pagos no disponible');
    }
    
    return { success: true, transactionId: `txn_${Date.now()}` };
  }
};

// Implementaci√≥n con patr√≥n Retry
async function processPayment(paymentData) {
  try {
    return await retry(
      async (bail) => {
        try {
          return await mockPaymentGateway.charge(paymentData);
        } catch (error) {
          if (error.message.includes('temporal')) {
            console.log(`üü° ${error.message} - Reintentando...`);
            throw error;
          }
          bail(error);
          return;
        }
      },
      {
        retries: 3,
        minTimeout: 1000,
        factor: 2,
        onRetry: (error) => {
          console.log(`‚è≥ Esperando ${error.attemptNumber * 1}s...`);
        }
      }
    );
  } catch (error) {
    console.error(`üî¥ Error final: ${error.message}`);
    return { success: false };
  }
}

// Ejecuci√≥n de prueba
(async () => {
  console.log('=== DEMO PATR√ìN RETRY EN E-COMMERCE ===');
  const result = await processPayment({ amount: 99.99 });
  console.log('Resultado final:', result);
})();

```

# Casos de Uso en E-Commerce

## Procesamiento de pagos:
- Reintentos cuando fallan conexiones con Stripe/PayPal.
- Backoff exponencial para evitar saturar el servicio.

## Reserva de inventario:
- Reintentos ante errores de concurrencia.
- Jitter para distribuir la carga.

## Sistema de recomendaciones:
- Reintentos con degradaci√≥n elegante (muestra resultados en cach√© primero).

## Notificaciones:
- Reintentos para enviar emails/notificaciones push.
- Encolamiento como fallback.

# Ventajas y Consideraciones

## Beneficios:
‚úì Mayor tasa de √©xito en transacciones.  
‚úì Mejor experiencia de usuario (menos errores visibles).  
‚úì Resiliencia autom√°tica ante fallas temporales.  

## Riesgos:
‚úó Puede enmascarar problemas subyacentes si no se monitorea.  
‚úó Posible saturaci√≥n si no se configura adecuadamente.  
‚úó No aplicable a operaciones no idempotentes.  

# Mejores Pr√°cticas
- Configurar l√≠mites razonables (3-5 reintentos).
- Usar backoff exponencial + jitter para evitar sincronizaci√≥n.
- Implementar circuit breakers para fallas prolongadas.
- Monitorear m√©tricas de reintentos (indicador de problemas).
- Evitar en operaciones no idempotentes (ej: POST que crean recursos).

# Conclusi√≥n
En sistemas de e-commerce, el patr√≥n Retry es esencial para manejar la inevitable inestabilidad de servicios distribuidos. Cuando se implementa correctamente, puede reducir fallas visibles al usuario en m√°s del 50%, mejorando significativamente la experiencia de compra y las m√©tricas de conversi√≥n.
